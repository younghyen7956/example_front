services:
  rag-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rag_api_container
    expose:
      - "8282"
    env_file:
      - ./backend/.env
    depends_on:
      - qdrant_db
    networks:
      - my-network

  qdrant_db: # 서비스 이름을 qdrant에서 qdrant_db로 명시적으로 변경 (rag-api의 depends_on과 일관성)
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./qdrant_data:/qdrant/storage # Qdrant 데이터의 지속성을 위해 볼륨 마운트
    container_name: qdrant_db
    networks:
      - my-network

  redis_db:
    image: redis:latest # 공식 Redis 이미지 사용
    container_name: redis_db
    ports:
      - "6379:6379" # 로컬에서 Redis를 직접 확인하고 싶을 때 사용
    volumes:
      - redis_volume:/data
    networks:
        - my-network

  # --- 프론트엔드 서비스 ---
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VUE_APP_FASTAPI_BASE_URL=/api # 백엔드 API의 새로운 기본 경로
    container_name: vue-app-container
    env_file:
      - ./frontend/.env
    networks:
      - my-network
    depends_on:
      - rag-api

  # --- Nginx 프록시 서비스 ---
  nginx:
    image: nginx:latest
    container_name: nginx_proxy
    ports:
      - "8080:80" # <-- 여기가 핵심 변경! 외부 8080 포트 -> Nginx 컨테이너 80 포트
    volumes:
      # 현재 nginx.conf 파일의 실제 위치에 맞게 설정 (예: ./frontend/nginx.conf)
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - my-network
    depends_on:
      - frontend # Nginx는 frontend가 준비된 후 시작
      - rag-api  # Nginx는 rag-api가 준비된 후 시작

# --- 네트워크 및 볼륨 정의 ---
volumes:
  qdrant_server_data:
    driver: local
  redis_volume: # <-- redis를 위한 명명된 볼륨 선언
    driver: local

networks:
  my-network:
    driver: bridge